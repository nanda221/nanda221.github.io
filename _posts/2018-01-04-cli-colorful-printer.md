---
layout: post
title:  "终端内容输出的体验提升，附Node.js和Python的常用套路"
subtitle: "Make the printer colorful"
date:   2018-01-04 23:59:59 +0800
background: '/img/posts/06.jpg'
---

## 终端输出的场景和诉求

我们通常所指的终端，即Shell命令行。通过在终端输出信息，我们可以完成如下几种工作：

1. 调试信息，随手一个print或者console；
2. 严谨的分级日志，比如[log4js-node](https://github.com/log4js-node/log4js-node) ，通过时间戳、Level等附加内容提升输出语义；
3. 交互式的命令行场景，比如以终端为“UI”的工具、工程体系等，这种场景在体验上的要求会更高。

本文重点讨论第三点，因为前面两点面向研发，忍忍就好。。，而终端输出的体验提升可以从流程、语义、颜值等方面入手，先讨论最肤浅的部分——颜值。

## 问题的本质

很多人都是从自己使用的编程语言生态的一些现成包开始润色命令行输出，比如NodeJS的[chalk](https://github.com/chalk/chalk)。但从本质来讲，内容最后流到shell标准输出(输出重定向除外)，那么不难猜想，一定是shell标准输出指定了某种格式范式，让输出内容可以被表示成“有颜色的”，而高级语言遵循这种范式，做内容output。

笔者不是Linux资深人员，所以直接查阅资料，把终端输出规则做个简单总结。

## 终端输出规则(Linux-like系统)

终端输出通过使用转义字符序列来表示输出属性的设置。转义序列以ESC(ASCII八进制为\033)开头，后面跟随属性设置。就颜色和样式举例，以下面代码举例表达更清楚：

```
# 设置规则
# 取值：前景色范围：30-37(黑、红、绿、黄、蓝、紫、青、白) 字体色范围：40-47(黑、红、绿、黄、蓝、紫、青、白)
# 和颜色有关基本格式：\033[显示方式;字体色;背景色m 字体色和背景色由于是不同数字区间来表示，所以前后顺序无所谓，也可以只传一个，分号分隔即可

# 例一：在shell命令行输入如下命令：
echo '\033[0;30;41mHello World!'     # 预期结果：命令行输出红底黑字

# 上面的代码做了两件事：
# 1. \033[0;30;41m指定输出的样式，\33[0;30;41m可以理解为\33[使用默认样式(0代表默认样式);黑色字体色;红色底色m
# 2. Hello World！是实际显示内容，会按照前面设置的展示样式做显示。
# 注意：属性设置不止作用于同命令中的输出内容，而且会影响本次回话的后续所有输出内容，直到有新的属性设置出现

# 例二：在例一的输出基础上，继续输入
echo 'The text is effected by former style setting.' # 预期结果：同样输出红底黑字，本行没有包含属性设置，但受了上面设置的影响
echo '\033[0;32;41m'                                 # 可以只输出属性设置，不带任何内容
echo '\033[32mtext style'                            # 只设置字体
echo '\033[41mtext style'                            # 只设置背景色
echo '\033[0mtext style'                             # 只设置显示方式为默认样式
echo 'The text style is reset now.'                  # 预期结果：样式回到终端默认样式
```

实际运行效果如下：
![](https://img.alicdn.com/tfs/TB1v57tlsLJ8KJjy0FnXXcFDpXa-1618-608.png)

> 注意：使用[oh my zsh](http://ohmyz.sh/)的同学可能会发现如果上面的命令单行逐个运行，输出和上面略有区别，即每次属性设置只作用于本次输出命令体中的内容，而不会影响到后续的输出。可以猜测，每次echo后，zsh对输出样式做了重置，类似于运行了**echo '\033[0m'**。

除了颜色还有很多可以使用的设置项：
```
# \033[0m 关闭所有属性
# \033[1m 设置高亮度
# \033[4m 下划线
# \033[5m 闪烁
# \033[7m 反显
# \033[8m 消隐
# \033[30m 至 33[37m 设置前景色  
# \033[40m 至 33[47m 设置背景色
# \033[nA 光标上移n行 
# \033[nB 光标下移n行
# \033[nC 光标右移n行
# \033[nD 光标左移n行
# \033[y;xH设置光标位置
# \033[2J 清屏
# \033[K 清除从光标到行尾的内容
# \033[s 保存光标位置 
# \033[u 恢复光标位置
# \033[?25l 隐藏光标
# \033[?25h 显示光标
```

## 规则深入解读

前面，我们使用**\033[显示方式;字体色;背景色m**这样“生硬”的板式来描述颜色设置规则。在看过上面的所有设置项后，我们进一步对这个规则做一个较准确的定义：

> 设置规则是以ESC转义字符(ASCII\033[)开头的一系列设置项的组合；设置项之间以;分隔，且按照从左向右的顺序依次生效；后面的设置项会覆盖前面，甚至同一个属性值都可以多次定义。

再举个颜色设置的例子，这次我们在Python3交互模式下运行：
```
# 定义字体颜色两次，后面的33(黄色)覆盖了32(绿色)
print('\033[3233mHello World!')
# 0m代表关闭所有属性，即重置，这次它出现在了设置项的最后一个，重置了前面的字体和背景色设置
print('\033[32;41;0mHello World!')
```

结果也符合上述的规则。

## 除了颜色，我们还可以...

看看下面这个例子：

```
print('\033[4;1H\033[1;4;32mHello,world\033[0m')
```

命令可以拆解为：\033[4;1H、\033[1m、\033[4m、\033[32m以及最后的\033[0m五条指令。注意命令中**[1;4;32m**的部分，由于都有m结尾，所以可以通过分号的方式做联写。
命令首先通过[4;1H将光标移动到终端第4行第1列，之后的[1;4;32m将文本属性设置为高亮、带下划线且颜色为绿色，然后输出Hello,world；最后[0m将终端属性恢复为默认值，这样就不会影响后续输出了。

## NodeJS、Python的流行类库

原理归原理，但这种“粗活”有很多前辈已经帮我们代劳了，封装成更高级、更语义化的社区类库。

* [chalk](https://github.com/chalk/chalk)是非常流行的NodeJS命令行润色库，支持文字样式相关的润色，如字体色、背景色、高亮、下划线等，而且支持非常优雅的Property Chain。
* [colorama](https://pypi.python.org/pypi/colorama/0.3.9)是一个跨平台的Python命令行润色模块。[这里](http://blog.csdn.net/qianghaohao/article/details/52117082)有一篇文章介绍了如何使用。


## 参考资料和延伸阅读

本文参考：

* [深入理解shell颜色输出与控制](http://www.jb51.net/article/100729.htm)
* [Python终端字符颜色](http://blog.csdn.net/qianghaohao/article/details/52117082)

[《命令行如何实现select》](http://blog.csdn.net/xia_xia0919/article/details/50559757)等更多的交互体验功能，有兴趣的朋友可以继续做延伸阅读，原理大致类似，再和命令行参数解析模块搭配使用可以构建一个完整的CLI交互模块，如NodeJS技术栈的[Inquirer.js](https://github.com/SBoudrias/Inquirer.js) + [chalk](https://github.com/chalk/chalk) + [yargs](https://github.com/yargs/yargs)，非常强大。
















